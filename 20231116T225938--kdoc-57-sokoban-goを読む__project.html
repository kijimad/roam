<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-01-12T10:49:51Z -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 57: sokoban-goを読む</title>
<meta name="author" content="kijimaD" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 57: sokoban-goを読む</h1>
<div id="outline-container-orged3d918" class="outline-2">
<h2 id="orged3d918"><a href="#orged3d918"><span class="done DONE">DONE</span> プロジェクトのステータス</a></h2>
<div class="outline-text-2" id="text-orged3d918">
<p>
プロジェクトは終了である。
</p>
</div>
</div>
<div id="outline-container-orgffe9b4b" class="outline-2">
<h2 id="orgffe9b4b"><a href="#orgffe9b4b">概要</a></h2>
<div class="outline-text-2" id="text-orgffe9b4b">
<p>
<a href="20210926145504-game.html#ID-8b79aef9-1073-4788-9e81-68cc63e4f997">game</a>を作るけど最後までうまくいった試しがない。人のコードを見る。
</p>

<ul class="org-ul">
<li>タイル空間の定石を探る
<ul class="org-ul">
<li>移動</li>
</ul></li>
<li>コンポーネントシステムの定石を探る</li>
</ul>
</div>
</div>
<div id="outline-container-org820f979" class="outline-2">
<h2 id="org820f979"><a href="#org820f979">タイル - スプライト</a></h2>
<div class="outline-text-2" id="text-org820f979">
<p>
タイルの上にあるものはスプライトとしているよう。<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L23-L30
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">const (
	exteriorSpriteNumber = 0
	wallSpriteNumber     = 1
	floorSpriteNumber    = 2
	goalSpriteNumber     = 3
	boxSpriteNumber      = 4
	playerSpriteNumber   = 5
)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdfa47f3" class="outline-2">
<h2 id="orgdfa47f3"><a href="#orgdfa47f3">タイルに対する操作</a></h2>
<div class="outline-text-2" id="text-orgdfa47f3">
<p>
タイルに対する操作一覧。論理演算で判断しているな。Set関数では自身を書き換える。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L54-L84
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Tile is a game tile
type Tile uint8

// List of game tiles
const (
	TilePlayer Tile = 1 &lt;&lt; iota
	TileBox
	TileGoal
	TileWall
	TileEmpty Tile = 0
)

// Contains checks if a game tile contains the provided tile
func (t *Tile) Contains(other Tile) bool {
	return (*t &amp; other) == other
}

// ContainsAny checks if a game tile contains any of the provided tiles
func (t *Tile) ContainsAny(other Tile) bool {
	return (*t &amp; other) != 0
}

// Set adds the provided tile to a game tile
func (t *Tile) Set(other Tile) {
	*t |= other
}

// Remove removes the provided tile to a game tile
func (t *Tile) Remove(other Tile) {
	*t &amp;= 0xFF ^ other
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe47550" class="outline-2">
<h2 id="orgbe47550"><a href="#orgbe47550">読み込み</a></h2>
<div class="outline-text-2" id="text-orgbe47550">
<p>
タイルはファイルから読み込んでいるようだ。よくわからない。タイルの縦×横の集合体がグリッドだ。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>func normalizeLevel(lines []string) ([][]byte, error)</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L165
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">grid := make([][]byte, len(lines))
</pre>
</div>

<p>
コンポーネントを追加している↓。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>func createFloorEntity(componentList *loader.EntityComponentList, gameSpriteSheet)</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L319-L327
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">func createFloorEntity(componentList *loader.EntityComponentList, gameSpriteSheet *ec.SpriteSheet, line, col int) {
	componentList.Engine = append(componentList.Engine, loader.EngineComponentList{
		SpriteRender: &amp;ec.SpriteRender{SpriteSheet: gameSpriteSheet, SpriteNumber: floorSpriteNumber},
		Transform:    &amp;ec.Transform{},
	})
	componentList.Game = append(componentList.Game, gameComponentList{
		GridElement: &amp;gc.GridElement{Line: line, Col: col},
	})
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd2b7907" class="outline-2">
<h2 id="orgd2b7907"><a href="#orgd2b7907">コンポーネントの定義</a></h2>
<div class="outline-text-2" id="text-orgd2b7907">
<p>
コンポーネントの種類の定義↓。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/lib.go#L13-L19
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">type gameComponentList struct {
	GridElement *gc.GridElement
	Player      *gc.Player
	Box         *gc.Box
	Goal        *gc.Goal
	Wall        *gc.Wall
}
</pre>
</div>

<p>
保持している構造体↓。コンポーネントを入れる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/components/lib.go#L5-L12
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Components contains references to all game components
type Components struct {
	GridElement *ecs.SliceComponent
	Player      *ecs.NullComponent
	Box         *ecs.NullComponent
	Goal        *ecs.NullComponent
	Wall        *ecs.NullComponent
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org4730643" class="outline-2">
<h2 id="org4730643"><a href="#org4730643">resources</a></h2>
<div class="outline-text-2" id="text-org4730643">
<p>
アクションが定数として表現されている。アクションmapのキーとして利用する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>定数</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/controls.go#L3-L7
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">const (
	// MoveUpAction is the action for moving up
	MoveUpAction = "MoveUp"
	// MoveUpFastAction is the action for moving up fast
	MoveUpFastAction = "MoveUpFast"
</pre>
</div>

<p>
アクションを初期化している部分(ライブラリ)↓。TOMLファイルから読み取って設定するよう。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>func LoadControls(controlsConfigPath string, axes []string, actions []string) (resources.Controls, resources.InputHandler)</label><pre class="src src-git-permalink">inputHandler.Actions = make(map[string]bool)
</pre>
</div>

<p>
TOMLファイル。対応関係がわかりやすい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/config/controls.toml#L1-L6
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">[controls.actions.MoveUp]
combinations = [[{ key = "Up" }]]
once = true

[controls.actions.MoveUpFast]
combinations = [[{ key = "ShiftLeft" }, { key = "Up" }], [{ key = "ShiftRight" }, { key = "Up" }]]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-toml">[<span class="org-type">controls.actions.MoveUp</span>]
<span class="org-variable-name">combinations</span> = [[{ key = <span class="org-string">"Up"</span> }]]
<span class="org-variable-name">once</span> = <span class="org-keyword">true</span>

[<span class="org-type">controls.actions.MoveUpFast</span>]
<span class="org-variable-name">combinations</span> = [[{ key = <span class="org-string">"ShiftLeft"</span> }, { key = <span class="org-string">"Up"</span> }], [{ key = <span class="org-string">"ShiftRight"</span> }, { key = <span class="org-string">"Up"</span> }]]
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc26b0a7" class="outline-2">
<h2 id="orgc26b0a7"><a href="#orgc26b0a7">prefab</a></h2>
<div class="outline-text-2" id="text-orgc26b0a7">
<p>
prefabが具体的にどういうことをするのかわからない。メニュー画面それぞれを保持しているぽい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/prefab.go#L5-L13
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// MenuPrefabs contains menu prefabs
type MenuPrefabs struct {
	MainMenu          loader.EntityComponentList
	ChoosePackageMenu loader.EntityComponentList
	PauseMenu         loader.EntityComponentList
	LevelCompleteMenu loader.EntityComponentList
	HighscoresMenu    loader.EntityComponentList
	SolutionsMenu     loader.EntityComponentList
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org170353b" class="outline-2">
<h2 id="org170353b"><a href="#org170353b">UI更新</a></h2>
<div class="outline-text-2" id="text-org170353b">
<p>
UIもコンポーネントである。↓UIコンポーネントを書き換えて表示する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>UIコンポーネント更新</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/pause_menu.go#L123-L137
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Update text components
world.Manager.Join(world.Components.Engine.Text, world.Components.Engine.UITransform).Visit(ecs.Visit(func(entity ecs.Entity) {
	text := world.Components.Engine.Text.Get(entity).(*ec.Text)

	switch text.ID {
	case "view_highscore":
		if st.invalidHighscore {
			text.Color = color.RGBA{0, 0, 0, 120}
		}
	case "view_solution":
		if st.invalidSolution {
			text.Color = color.RGBA{0, 0, 0, 120}
		}
	}
}))
</pre>
</div>

<p>
↓コンポーネントはTOMLで定義されているようだ。各メニューごとにファイルがあるな。translationは配置する座標だな。なぜこの単語が使われているのかわからない。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/assets/metadata/entities/ui/main_menu.toml#L27-L34
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">[entity.components.Text]
id = "cursor_view_highscores"
text = "\u25ba"
font_face = { font = "hack", options.size = 60.0 }
color = [255, 255, 255, 255]

[entity.components.UITransform]
translation = { x = 40, y = 400 }
</pre>
</div>

<ul class="org-ul">
<li><a href="https://developer.mozilla.org/ja/docs/Web/CSS/transform"> transform - CSS: カスケーディングスタイルシート | MDN</a></li>
</ul>

<p>
画像を移動や拡大縮小など変化させるのをtransformというようだ。
</p>
</div>
</div>
<div id="outline-container-org576e808" class="outline-2">
<h2 id="org576e808"><a href="#org576e808">メニューコンポーネントのマウスオーバーイベント</a></h2>
<div class="outline-text-2" id="text-org576e808">
<p>
↓メニューコンポーネントそれぞれで、マウスが上にあるかを判定する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L41-L46
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Handle mouse events only if mouse is moved or clicked
x, y := ebiten.CursorPosition()
if x != menuLastCursorPosition.X || y != menuLastCursorPosition.Y || inpututil.IsMouseButtonJustPressed(ebiten.MouseButtonLeft) {
	menuLastCursorPosition = m.VectorInt2{X: x, Y: y}

	for iElem, id := range menu.getMenuIDs() {
</pre>
</div>

<p>
↓コンポーネントのクエリ。レンダーできる、変形可能、マウスが反応可能、といった性質を持つものを対象にする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L47
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">if world.Manager.Join(world.Components.Engine.SpriteRender, world.Components.Engine.Transform, world.Components.Engine.MouseReactive).Visit(
</pre>
</div>

<p>
↓コンポーネントを特定して、stateの <code>selection</code> (選択中の項目)を変える。クリックされていた場合は、遷移する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L48-L59
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">func(index int) (skip bool) {
	mouseReactive := world.Components.Engine.MouseReactive.Get(ecs.Entity(index)).(*ec.MouseReactive)
	if mouseReactive.ID == id &amp;&amp; mouseReactive.Hovered {
		menu.setSelection(iElem)
		if mouseReactive.JustClicked {
			transition = menu.confirmSelection(world)
			return true
		}
	}
	return false
}) {
return transition
</pre>
</div>
</div>
</div>
<div id="outline-container-org625aebf" class="outline-2">
<h2 id="org625aebf"><a href="#org625aebf">GridElementとは何か</a></h2>
<div class="outline-text-2" id="text-org625aebf">
<p>
↓グリッドを置き換えるシステムがある。グリッドは座標を持つことを示す。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_transform.go#L16-L17
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// GridTransformSystem sets transform for grid elements
func GridTransformSystem(world w.World) {
</pre>
</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_transform.go#L20
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">world.Manager.Join(gameComponents.GridElement, world.Components.Engine.SpriteRender, world.Components.Engine.Transform).Visit(ecs.Visit(func(entity ecs.Entity) {
</pre>
</div>

<ul class="org-ul">
<li>GridElement &#x2013; 座標を持つことを示す</li>
<li>SpriteRender &#x2013; 描画可能なことを示す</li>
<li>Transform &#x2013; 何かわからない
<ul class="org-ul">
<li>壁、箱、プレイヤー、UI…など描画されるものについている</li>
<li>画像変換か</li>
</ul></li>
</ul>

<p>
このシステムはタイルの変化をEntityに及ぼす、という感じか。
</p>

<p>
↓タイルの中からプレイヤー、箱を探す。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>プレイヤー、箱を探す</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_update.go#L18-L25
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">for iTile, tile := range gameResources.Level.Grid.Data {
	switch {
	case tile.Contains(resources.TilePlayer):
		playerIndex = iTile
	case tile.Contains(resources.TileBox):
		boxIndices = append(boxIndices, iTile)
	}
}
</pre>
</div>

<p>
プレイヤーコンポーネント、箱コンポーネントのgridElementを更新する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>コンポーネントによって分岐</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_update.go#L33-L47
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">world.Manager.Join(gameComponents.GridElement).Visit(ecs.Visit(func(entity ecs.Entity) {
	switch {
	case entity.HasComponent(gameComponents.Player):
		gridElement := gameComponents.GridElement.Get(entity).(*gc.GridElement)
		gridElement.Line = paddingRow + playerIndex/levelWidth
		gridElement.Col = paddingCol + playerIndex%levelWidth

	case entity.HasComponent(gameComponents.Box):
		gridElement := gameComponents.GridElement.Get(entity).(*gc.GridElement)
		boxIndex := boxIndices[0]
		boxIndices = boxIndices[1:]
		gridElement.Line = paddingRow + boxIndex/levelWidth
		gridElement.Col = paddingCol + boxIndex%levelWidth
	}
}))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc9bf45f" class="outline-2">
<h2 id="orgc9bf45f"><a href="#orgc9bf45f">InfoSystemとは何か</a></h2>
<div class="outline-text-2" id="text-orgc9bf45f">
<p>
GridElementと同様に、タイルの状態をエンティティに反映する。今回はUIエンティティ。
</p>

<p>
↓箱の数、正しく配置されている箱の数をカウントする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>func InfoSystem(world w.World, solutionMode bool) {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/info.go#L21-L29
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">for _, tile := range gameResources.Level.Grid.Data {
	if tile.Contains(resources.TileBox) {
		boxCount += 1

		if tile.Contains(resources.TileGoal) {
			boxOnGoalCount += 1
		}
	}
}
</pre>
</div>

<p>
↓テキストコンポーネントを更新する。IDで分岐する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/info.go#L31-L51
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Set text info
world.Manager.Join(world.Components.Engine.Text, world.Components.Engine.UITransform).Visit(ecs.Visit(func(entity ecs.Entity) {
	text := world.Components.Engine.Text.Get(entity).(*ec.Text)

	switch text.ID {
	case "level":
		text.Text = fmt.Sprintf("LEVEL %d/%d", gameResources.Level.CurrentNum+1, len(gameResources.Package.Levels))
		if !solutionMode &amp;&amp; gameResources.Level.Modified {
			text.Text += "(*)"
		}
	case "box":
		text.Text = fmt.Sprintf("BOX: %d/%d", boxOnGoalCount, boxCount)
	case "step":
		text.Text = fmt.Sprintf("STEPS: %d", len(gameResources.Level.Movements))
	case "package":
		text.Text = fmt.Sprintf("Package: %s", gameResources.Package.Name)
		if solutionMode {
			text.Text += " - Replaying solution..."
		}
	}
}))
</pre>
</div>
</div>
</div>
<div id="outline-container-org52a4b9a" class="outline-2">
<h2 id="org52a4b9a"><a href="#org52a4b9a">Resourceとは何か</a></h2>
<div class="outline-text-2" id="text-org52a4b9a">
<p>
ECS用語におけるリソースとは何か。エンティティに関係ないデータのこと。マップデータとかかな。
</p>

<div class="org-src-container">
<pre class="src src-go">// Resources contains references to data not related to any entity
type Resources struct {
</pre>
</div>

<p>
↓ゲームリソース。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/game.go#L128-L135
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Game contains game resources
type Game struct {
	StateEvent StateEvent
	Package    PackageData
	Level      Level
	GridLayout GridLayout
	SaveConfig SaveConfig
}
</pre>
</div>

<dl class="org-dl">
<dt>StateEvent</dt><dd>完了したかどうか</dd>
<dt>PackageData</dt><dd>読み込んだPackageのデータ。Packageはステージのセット</dd>
<dt>Level</dt><dd>現在の階層(難易度)。階層数、移動履歴、グリッド情報を持つ</dd>
</dl>
</div>
</div>
<div id="outline-container-org0e283ac" class="outline-2">
<h2 id="org0e283ac"><a href="#org0e283ac">タイル</a></h2>
<div class="outline-text-2" id="text-org0e283ac">
<p>
↓タイルの状態一覧。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/game.go#L105-L112
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// List of game tiles
const (
	TilePlayer = gloader.TilePlayer
	TileBox    = gloader.TileBox
	TileGoal   = gloader.TileGoal
	TileWall   = gloader.TileWall
	TileEmpty  = gloader.TileEmpty
)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbd922ef" class="outline-2">
<h2 id="orgbd922ef"><a href="#orgbd922ef">stateとsystemの関係</a></h2>
<div class="outline-text-2" id="text-orgbd922ef">
<p>
stateによって適用systemが異なる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/gameplay.go#L65-L72
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">func (st *GameplayState) Update(world w.World) states.Transition {
	g.SwitchLevelSystem(world)
	g.UndoSystem(world)
	g.MoveSystem(world)
	g.SaveSystem(world)
	g.InfoSystem(world, false)
	g.GridUpdateSystem(world)
	g.GridTransformSystem(world)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc174389" class="outline-2">
<h2 id="orgc174389"><a href="#orgc174389">移動はどうやっているか</a></h2>
<div class="outline-text-2" id="text-orgc174389">
<p>
↓systemではこうしている。シンプルにリソースの値に応じてMove()を呼んでいる。ボタン押下に応じて、Actionsがセットされてるはず。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/move.go#L9-L11
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// MoveSystem moves player
func MoveSystem(world w.World) {
	moveUpAction := world.Resources.InputHandler.Actions[resources.MoveUpAction]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/move.go#L21-L23
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">switch {
case moveUpAction || moveUpFastAction:
	resources.Move(world, resources.MovementUp)
</pre>
</div>

<p>
↓Actionsの中身は、アクション文字列とboolのマップである。
</p>

<div class="org-src-container">
<pre class="src src-go">// InputHandler contains input axis values and actions corresponding to specified controls
type InputHandler struct {
	// Axes contains input axis values
	Axes map[string]float64
	// Actions contains input actions
	Actions map[string]bool
}
</pre>
</div>

<p>
↓このように、キーボード押下時Actionsにセットする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>func (st *LevelCompleteState) Update(world w.World) states.Transition {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/level_complete_menu.go#L121-L123
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">if inpututil.IsKeyJustPressed(ebiten.KeyEnter) || inpututil.IsKeyJustPressed(ebiten.KeySpace) {
	world.Resources.InputHandler.Actions[resources.RestartAction] = true
}
</pre>
</div>

<p>
↓そのあとsystemで処理する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>func SwitchLevelSystem(world w.World) bool {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/switch_level.go#L17
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">restartAction := world.Resources.InputHandler.Actions[resources.RestartAction]
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>func SwitchLevelSystem(world w.World) bool {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/switch_level.go#L25-L28
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">case restartAction:
	gameResources.Level.Movements = []resources.MovementType{}
	gameResources.Level.Modified = true
	newLevel = gameResources.Level.CurrentNum
</pre>
</div>
</div>
</div>
<div id="outline-container-org6f1fcc3" class="outline-2">
<h2 id="org6f1fcc3"><a href="#org6f1fcc3">InputHandlerのリセットはどこでやっているか</a></h2>
<div class="outline-text-2" id="text-org6f1fcc3">
<p>
world.Resources.InputHandlerはさまざまなところで使われている。これはボタンの押下状態に応じて値が変わるように見える。リセットが必要だが、どこでやっているか。
</p>

<p>
↓ECSライブラリのなかでやっている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>func InputSystem(world w.World) {}</label><pre class="src src-go">for k, v := range world.Resources.Controls.Actions {
	world.Resources.InputHandler.Actions[k] = isActionDone(v)
}
</pre>
</div>

<p>
↑InputSyste関数は、StateMachineのUpdateで呼ばれる。なので、毎回リセットされているのだろう。
</p>

<p>
この設計にすることで、キーボード押下を1箇所で管理できる。直接それぞれの箇所でキーボード押下を検知するよりも見通しやすい。キー検知は具体的すぎるコードだ。
</p>
</div>
</div>
<div id="outline-container-org098dd97" class="outline-2">
<h2 id="org098dd97"><a href="#org098dd97">メニューの抽象化</a></h2>
<div class="outline-text-2" id="text-org098dd97">
<p>
↓複数あるメニューは、このように抽象化されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L16-L22
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">type menu interface {
	getSelection() int
	setSelection(selection int)
	confirmSelection(world w.World) states.Transition
	getMenuIDs() []string
	getCursorMenuIDs() []string
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd64ede2" class="outline-2">
<h2 id="orgd64ede2"><a href="#orgd64ede2">どうやって描画しているか</a></h2>
<div class="outline-text-2" id="text-orgd64ede2">
<ul class="org-ul">
<li>読み込み時にコンポーネントを初期化する
<ul class="org-ul">
<li>初期化 = Prefabをセットする</li>
<li>tomlから読み込む</li>
<li>主なコンポーネントはtext。idやtextなどを持つ</li>
<li>あるいはマウスに反応するコンポーネントもある</li>
</ul></li>
<li>各stateでsystemを実行し、コンポーネントに変更を加える</li>
<li>stateMachineの内でSystemを実行している。どのステートでも描画する</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>stateが描画している部分</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/goecsengine/blob/be27b724d4c8f46b9d31959fe91c4ecf188429ea/states/lib.go#L98-L103
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// Draw draws the screen after a state update
func (sm *StateMachine) Draw(world w.World, screen *ebiten.Image) {
	// Run drawing systems
	s.RenderSpriteSystem(world, screen)
	u.RenderUISystem(world, screen)
}
</pre>
</div>

<p>
↓呼び出されているRenderSpriteSystemの抜粋。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>コンポーネントを描画する</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/goecsengine/blob/be27b724d4c8f46b9d31959fe91c4ecf188429ea/systems/sprite/render.go#L21-L25
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">// RenderSpriteSystem draws images.
// Images are drawn in ascending order of depth.
// Images with higher depth are thus drawn above images with lower depth.
func RenderSpriteSystem(world w.World, screen *ebiten.Image) {
	sprites := world.Manager.Join(world.Components.Engine.SpriteRender, world.Components.Engine.Transform)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd9dabfe" class="outline-2">
<h2 id="orgd9dabfe"><a href="#orgd9dabfe">StateMachineがどういう感じになっているか</a></h2>
<div class="outline-text-2" id="text-orgd9dabfe">
<p>
ステートのスタック構造を持っているが、これはどういう感じで推移するか。
</p>

<ul class="org-ul">
<li>おそらくスタック構造があるために、メニュー画面を出したあとに元のステートに戻れる</li>
<li>貯まり続けないことを保証するには</li>
</ul>
</div>
</div>
<div id="outline-container-org985d0fd" class="outline-2">
<h2 id="org985d0fd"><a href="#org985d0fd">スプライトを動的に追加する</a></h2>
<div class="outline-text-2" id="text-org985d0fd">
<p>
真っ黒な画像をスプライト画像として登録して、フェードアウトとしている。スプライトをファイルで読み込むほかに、こういったこともできる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/main.go#L73-L75
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">textureImage := ebiten.NewImage(minGameWidth, minGameHeight)
textureImage.Fill(color.RGBA{A: 120})
spriteSheets["fadeOut"] = ec.SpriteSheet{Texture: ec.Texture{Image: textureImage}, Sprites: []ec.Sprite{{Width: minGameWidth, Height: minGameHeight}}}
</pre>
</div>
</div>
</div>
<div id="outline-container-org20b206d" class="outline-2">
<h2 id="org20b206d"><a href="#org20b206d">stateとentity</a></h2>
<div class="outline-text-2" id="text-org20b206d">
<p>
stateごとでファイルからentityを生成し直している。そこから、systemでいろいろentityを操作している。
</p>
</div>
</div>
<div id="outline-container-orgca2ff2b" class="outline-2">
<h2 id="orgca2ff2b"><a href="#orgca2ff2b">Tasks</a></h2>
<div class="outline-text-2" id="text-orgca2ff2b">
<p>
なし。
</p>
</div>
</div>
<div id="outline-container-org546e7f7" class="outline-2">
<h2 id="org546e7f7"><a href="#org546e7f7">Archives</a></h2>
<div class="outline-text-2" id="text-org546e7f7">
</div>
<div id="outline-container-orgfdbddce" class="outline-3">
<h3 id="orgfdbddce"><a href="#orgfdbddce"><span class="done DONE">DONE</span> 読む</a></h3>
<div class="outline-text-3" id="text-orgfdbddce">
<p>
コードを読む。
</p>
</div>
</div>
</div>
<div id="outline-container-orgf6df7db" class="outline-2">
<h2 id="orgf6df7db"><a href="#orgf6df7db">関連</a></h2>
<div class="outline-text-2" id="text-orgf6df7db">
<ul class="org-ul">
<li>動機: <a href="20230909T204817--kdoc-28-交通シミュレーションゲームを作る__project.html#ID-20230909T204817">KDOC 28: 交通シミュレーションゲームを作る</a>。で挫折したので先人のコードを読んでみることにした</li>
</ul>
</div>
</div>
<div id="outline-container-orgde6471b" class="outline-2">
<h2 id="orgde6471b"><a href="#orgde6471b">Backlinks</a></h2>
<div class="outline-text-2" id="text-orgde6471b">
<ul class="org-ul">
<li><a href="./20231128T074518--kdoc-59-ecsを使ってrpgを作る__project.html">KDOC 59: ECSを使ってRPGを作る</a></li>
</ul>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
ゲームづくりの定石知識が足りてない。
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
