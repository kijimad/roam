<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-12-13T18:57:47Z -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 495: 文芸的にDB動作を検証できるようにする</title>
<meta name="author" content="kijimaD" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 495: 文芸的にDB動作を検証できるようにする</h1>
<div id="outline-container-orgd5484fc" class="outline-2">
<h2 id="orgd5484fc"><a href="#orgd5484fc">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-orgd5484fc">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="off"><input type='checkbox' /> &lt;署名&gt;</li>
</ul></li>
</ul>

<ul class="org-ul">
<li>レビュー
<ul class="org-ul">
<li class="off"><input type='checkbox' /> &lt;署名&gt;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7ab2ade" class="outline-2">
<h2 id="org7ab2ade"><a href="#org7ab2ade">概要</a></h2>
<div class="outline-text-2" id="text-org7ab2ade">
<p>
文芸的にDB動作を検証できるようにした。
</p>
</div>
</div>
<div id="outline-container-orgec9e08b" class="outline-2">
<h2 id="orgec9e08b"><a href="#orgec9e08b">背景</a></h2>
<div class="outline-text-2" id="text-orgec9e08b">
<p>
<a href="https://syu-m-5151.hatenablog.com/entry/2025/11/25/135220">「Postgres で試した？」と聞き返せるようになるまでもしくはなぜ私は雰囲気で技術を語るのか？</a>を読んで、データベースの機能について知らないことが多いのを知った。
</p>

<p>
コンピュータのほかの事柄と同様に、じっさいに試して、挙動を仔細にみて背景にあるアイデアを理解し、自分なりのモデルを構築していくのが必要に見えた。REPLでいじるだけでなく、体系立てて記録しつつ試していけるとよさそうである。
</p>

<p>
そういうことを気軽にできるようにした。
</p>
</div>
</div>
<div id="outline-container-org87832c2" class="outline-2">
<h2 id="org87832c2"><a href="#org87832c2">要件</a></h2>
<div class="outline-text-2" id="text-org87832c2">
<ul class="org-ul">
<li>少ない準備で気軽にデータベースを実行できる</li>
<li>文芸的プログラミングができる。入力と標準出力をテキストに残し、そのままドキュメント化できる
<ul class="org-ul">
<li>入力クエリを出力にエコー表示できる</li>
</ul></li>
<li>毎回クリーンな環境で、完全に再現できる</li>
<li>org-mode org-babelの <code>sql</code> ブロックから直接使える</li>
<li>完全に同等の機能が使える。インデックス、EXPLAIN、トランザクション&#x2026;が使える</li>
</ul>
</div>
</div>
<div id="outline-container-org89c5c4e" class="outline-2">
<h2 id="org89c5c4e"><a href="#org89c5c4e">使用例</a></h2>
<div class="outline-text-2" id="text-org89c5c4e">
<p>
リポジトリは<a href="https://github.com/kijimad/pgpg">kijimad/pgpg</a>にある。
</p>

<p>
根本的なアイデアは、データベースのプロキシを実装し、フック処理を追加することである。プロキシで、実験に必要な処理(DB初期化と削除)を実行する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>DBとプロキシを起動する</label><pre class="src src-shell">docker compose up -d
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>org-modeの見出しやファイルヘッダに接続先情報を書く</label><pre class="src src-org-mode">:PROPERTIES:
  :header-args+: :results table
  :header-args+: :database postgres
  :header-args+: :dbhost localhost
  :header-args+: :dbport 15432
  :header-args+: :dbuser postgres
  :header-args+: :engine postgresql
:END:
</pre>
</div>

<p>
あとは、org-babelでSQLを実行して評価する。
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> 1+1 <span class="org-keyword">as</span> <span class="org-keyword">result</span>;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">|                         |
|-------------------------|
| &gt; select 1+1 as result; |
| result                  |
| 2                       |
</pre>
</div>

<p>
データベースは接続のたびにリセットされる。完全に再現可能で、あとで読みやすい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>リセットされるので実行のたびに同じ結果が出る</label><pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">users</span> (
    <span class="org-keyword">name</span> <span class="org-type">varchar</span>(255),
    tel <span class="org-type">integer</span>
);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> users (<span class="org-keyword">name</span>, tel) <span class="org-keyword">VALUES</span> (<span class="org-string">'&#12365;&#12376;&#12414;'</span>, 100);
<span class="org-keyword">SELECT</span> * <span class="org-keyword">FROM</span> users;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">|                                                         |     |
|---------------------------------------------------------+-----|
| &gt; CREATE TABLE users (                                  |     |
| &gt;     name varchar(255),                                |     |
| &gt;     tel integer                                       |     |
| &gt; );                                                    |     |
| CREATE TABLE                                            |     |
|                                                         |     |
| &gt; INSERT INTO users (name, tel) VALUES ('きじま', 100); |     |
| INSERT 0 1                                              |     |
|                                                         |     |
| &gt; SELECT * FROM users;                                  |     |
| name                                                    | tel |
| きじま                                                  | 100 |
</pre>
</div>
</div>
</div>
<div id="outline-container-org57b192f" class="outline-2">
<h2 id="org57b192f"><a href="#org57b192f">関連</a></h2>
<div class="outline-text-2" id="text-org57b192f">
<ul class="org-ul">
<li>動機: <a href="20240207T092747--kdoc-77-検証する方法があると理解が進む__essay.html#ID-20240207T092747">KDOC 77: 検証する方法があると理解が進む</a>。に基づいて作った</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
